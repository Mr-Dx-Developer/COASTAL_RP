import{u as h,r as s,q as o,$ as he,A as H,bb as M,P as w,p as c,bc as ve,bd as be,be as Ce,C as K,a as n,F as ae,j as v,bf as Se,bg as ye,bh as Ae,L as re,s as $,bi as we,bj as se,bk as Oe,bl as Pe,aA as Re,aU as Ie,a3 as ke,t as ne,a7 as Ne,b3 as Le,b as Me,U as Ve}from"./index-5ca133d9.js";function Ke(){const p=h(Me);h(K.CameraComponent);const z=h(M.Unlocked),ie=h(M.PassedFaceId),R=h(M.Visible);h(M.LockScreenVisible);const[F,O]=s.useState(!1),[i,T]=s.useState("Photo"),[V,X]=s.useState(!1),[oe,G]=s.useState(!1),[W,E]=s.useState(null),[b,q]=s.useState(!1),[d,ce]=s.useState(!1),[Q,J]=s.useState(0),[le,x]=s.useState({}),f=h(Ve),m=h(H),B=s.useRef(null),U=s.useRef(null),C=s.useRef(null),u=s.useRef(null),I=s.useRef(!1),S=s.useRef(null),y=s.useRef(!1),g=["Video","Photo","Landscape"];s.useEffect(()=>{var e;y.current=!(f!=null&&f.visible)&&((e=m==null?void 0:m.active)==null?void 0:e.name)==="Camera"&&R},[C.current,f==null?void 0:f.visible,m==null?void 0:m.active,R]);const ue=()=>{var e;o("info","Camera app is not active or open, pausing game render & releasing audio stream"),I.current=!1,(e=u.current)==null||e.pause(),S.current&&(se("Camera"),S.current=null),i==="Landscape"&&c("Camera",{action:"toggleLandscape",toggled:!1},"OK"),c("Camera",{action:"close"},"OK")},de=async()=>{var r;if(I.current=!0,o("info","Camera app is active & open, initializing game render & audio stream"),u.current?u.current.paused&&u.current.resume():u.current=new Oe(C.current),!S.current){const t=await Pe("Camera");if(!y.current){o("info","camera app is no longer open, releasing audio stream"),se("Camera");return}t&&(S.current=t)}c("Camera",{action:"open"},"OK"),c("Camera",{action:"flipCamera",value:b},"OK"),i==="Landscape"&&!((r=Re)!=null&&r.value)?(c("Camera",{action:"toggleLandscape",toggled:!0},"OK"),w.Styles.Rotation.set(90)):i==="Video"&&c("Camera",{action:"toggleVideo",toggled:!0},"OK");const e=$.APPS.CAMERA.lastImage.value||await c("Camera",{action:"getLastImage"},Ie.Photos[0].src);e&&Y(e),I.current=!1};s.useEffect(()=>{if(o("info","Camera app active:",y.current),!C.current)return o("warning","Canvas ref is null");y.current&&I.current&&o("info","Camera app is already initializing, returning"),y.current?I.current||de():ue()},[y.current,C.current]),he("camera:usedCommand",e=>{var r;if(f!=null&&f.visible||((r=m==null?void 0:m.active)==null?void 0:r.name)!=="Camera"||!R)return o("info","camera:usedCommand - camera is not active, returning");switch(e){case"toggleTaking":k();break;case"toggleFlip":q(t=>!t);break;case"toggleFlash":X(t=>!t);break;case"leftMode":if(d)return;T(t=>{const a=g.indexOf(t);return a===0?g[g.length-1]:g[a-1]});break;case"rightMode":if(d)return;T(t=>{const a=g.indexOf(t);return a===g.length-1?g[0]:g[a+1]});break}}),s.useEffect(()=>{if(!U.current)return;let e=[];const t=setInterval(()=>{e.length>2&&(e=[]),e.push("."),U.current.innerText=re("APPS.CAMERA.UPLOADING")+e.join("")},500);return()=>clearInterval(t)},[F]);const Y=(e,r)=>{if(r===void 0&&(r=ke(e)),r){const t=document.createElement("video");t.src=e,t.muted=!0,t.play();const a=document.createElement("canvas");if(!a)return;t.addEventListener("loadeddata",()=>{a.width=t.videoWidth,a.height=t.videoHeight,a.getContext("2d").drawImage(t,0,0,a.width,a.height);const P=a.toDataURL("image/png");B.current.style.backgroundImage=`url(${P})`,$.APPS.CAMERA.lastImage.set(P),a.remove(),t.remove()})}else B.current.style.backgroundImage=`url(${e})`,$.APPS.CAMERA.lastImage.set(e)};s.useEffect(()=>{if(!R)return()=>{H.patch({active:null}),z||M.LockScreenVisible.set(!0)}},[R]),s.useEffect(()=>{if(d||!u.current)return;switch(i){case"Landscape":x({marginRight:"9rem"}),w.Styles.Rotation.set(90);break;case"Video":w.Styles.Rotation.set(0),x({marginLeft:"12rem"});break;default:w.Styles.Rotation.set(0),x({marginLeft:"3rem"});break}i==="Landscape"?u.current.resizeByAspect(16/9):(i==="Video"||i==="Photo")&&u.current.resizeByAspect(3/4),c("Camera",{action:"toggleLandscape",toggled:i==="Landscape"},"OK"),c("Camera",{action:"toggleVideo",toggled:i==="Video"},"OK");const e=window.innerWidth;e>1920&&u.current.setQuality(1920/e),i==="Photo"&&b?u.current.setXOffset(-.2):u.current.setXOffset(0)},[i]),s.useEffect(()=>{if(c("Camera",{action:"flipCamera",value:b},"OK"),!d){if(!y.current)return o("info","Camera app is not active, returning");i=="Photo"&&b?u.current.setXOffset(-.2):u.current.setXOffset(0)}},[z,b]);const Z=s.useRef(!0),_=async(e,r)=>{const t=ne(e.size/1e3,2);V&&c("toggleFlashlight",{toggled:!1},"OK");try{const a=await Ne(r?"Video":"Image",e);if(!a)throw new Error("Failed to upload media (URL is null)");return Y(a),o("info",`Saving ${r?"video":"photo"} to gallery (${t}kb) - ${a}, args(${a}, ${t}, ${b&&!r?"selfie":null})`),await Le(a,t,b&&!r?"selfie":null,!0),!0}catch(a){throw a}};s.useEffect(()=>{if(Z.current){Z.current=!1;return}if(V&&!d&&c("toggleFlashlight",{toggled:!1},"OK"),!d)return;const e=C.current.captureStream(p.videoOptions.fps),r=new AudioContext,t=new MediaStreamAudioDestinationNode(r);S.current?r.createMediaStreamSource(S.current).connect(t):r.createOscillator().connect(t),ve("Camera",r,t);const a=[e.getVideoTracks()[0]];(S.current||p.recordNearbyVoices)&&a.unshift(t.stream.getAudioTracks()[0]);const P=new MediaStream(a),A=new MediaRecorder(P,{mimeType:"video/webm;codecs=vp9,opus",videoBitsPerSecond:p.videoOptions.bitrate*8*1e3});let D=0;const me=A.audioBitsPerSecond+A.videoBitsPerSecond,ee=setInterval(()=>{const l=(Date.now()-D)/1e3,j=me*l/8/1024/1024,L=ne(j,2);L>=p.videoOptions.size&&(o("info",`Video file size limit reached (${L}mb)`),clearInterval(ee),k())},100);let te=[];A.ondataavailable=l=>{var N;((N=l==null?void 0:l.data)==null?void 0:N.size)>0&&te.push(l.data)},A.onerror=l=>{o("error","error recording:",l)},A.onstop=async()=>{clearInterval(ee);let l=Date.now()-D,N=new Blob(te,{type:"video/webm"});r.close(),O(!0),be("Camera");const j=await Ce(N,l,{logger:!1});try{await _(j,!0),o("info","Video uploaded successfully"),O(!1)}catch(L){o("error","Could not upload video",L),O(!1),E(L.message),await new Promise(pe=>setTimeout(pe,1e4)),E(null)}},D=Date.now(),A.start();const ge=setInterval(()=>{if(Q>=p.videoOptions.duration)return k();J(l=>l+1>=p.videoOptions.duration?(k(),0):l+1)},1e3);return()=>{J(0),clearInterval(ge),A.stop()}},[d]);const fe=e=>{let r=(e%60).toString().padStart(2,"0"),t=(Math.floor(e/60)%60).toString().padStart(2,"0");return Math.floor(e/3600).toString().padStart(2,"0")+":"+t+":"+r},k=async()=>{var r,t;if(F)return o("info","Returning since an image is currently uploading");if(V&&await c("toggleFlashlight",{toggled:!0},"OK"),i=="Video"){await c("Camera",{action:"toggleHud",toggled:d},"OK"),ce(a=>!a);return}await c("Camera",{action:"toggleHud",toggled:!1},"OK"),(t=(r=w.Settings.value)==null?void 0:r.sound)!=null&&t.silent||w.SoundManager.set({url:"./assets/sound/other/cameraShutter.mp3"}),G(!0),K.IndicatorVisible.set(!1),O(!0),o("info","Uploading image, converting to blob");const e=await new Promise(a=>C.current.toBlob(a,p.imageOptions.mime,p.imageOptions.quality));try{await _(e,!1),o("info","Image uploaded successfully"),O(!1),K.IndicatorVisible.set(!0)}catch(a){o("error","Could not upload image",a),O(!1),E(a.message),K.IndicatorVisible.set(!0),await new Promise(P=>setTimeout(P,1e4)),E(null)}G(!1),c("Camera",{action:"toggleHud",toggled:!0},"OK")};return n(ae,{children:v("div",{className:"camera-container",children:[v("div",{className:"camera-header",children:[n("div",{className:"flash",onClick:()=>X(e=>!e),children:!d&&V?n(Se,{}):n(ye,{})}),i==="Video"&&v(ae,{children:[n("div",{className:"timer",children:fe(Q)}),n("span",{})]})]}),v("div",{className:`camera-body ${i=="Landscape"?"rotate":""}`,children:[n("canvas",{ref:C,style:{visibility:oe?"hidden":"visible"}}),F&&v("div",{className:"loading",children:[n(Ae,{size:80,speed:1,color:"#ffffff"}),n("div",{className:"uploading",ref:U,children:"Uploading..."})]}),W&&n("div",{className:"loading",children:v("div",{className:"uploading",children:["Failed to upload, tell the server owner to check their API keys in lb-phone/server/apiKeys.lua",n("br",{}),n("br",{}),W]})})]}),v("div",{className:"camera-bottom",children:[n("div",{className:"camera-types",style:le,children:g.map((e,r)=>n("div",{className:`${i===e&&"active"}`,onClick:()=>T(e),children:re(`APPS.CAMERA.${e.toUpperCase()}`)},r))}),v("div",{className:"camera-buttons",children:[n("div",{className:"image-gallery",ref:B,onClick:()=>{!ie&&!z||(c("Camera",{action:"close"},"OK"),w.Styles.Rotation.set(0),H.patch({active:{name:"Photos",data:{photo:$.APPS.CAMERA.lastImage.value}}}))}}),n("div",{className:"camera-button",onClick:()=>k(),children:n("div",{className:"camera-button-container",children:n("div",{className:`camera-button-inner ${i=="Video"&&`${i} ${d==!0&&"Recording"}`}`})})}),n("div",{className:"flip-camera",onClick:()=>q(e=>!e),children:n(we,{})})]})]})]})})}export{Ke as default};
